// Copyright 2020 Google LLC
//
// Licensed under the Apache License, Version 2.0 (the "License");
// you may not use this file except in compliance with the License.
// You may obtain a copy of the License at
//
//     https://www.apache.org/licenses/LICENSE-2.0
//
// Unless required by applicable law or agreed to in writing, software
// distributed under the License is distributed on an "AS IS" BASIS,
// WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
// See the License for the specific language governing permissions and
// limitations under the License.
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // Limited rules execution environment and functions are constrained:
    // https://firebase.google.com/docs/rules/rules-language#function
    // https://github.com/google/cel-spec/blob/master/doc/langdef.md
    function quickPad(datePart) {
      return datePart.size() == 1 ? "0" + datePart : datePart;
    }

    // Assemble YYYY-MM-DD-HH from timestamp
    function buildDatePath(t) {
      return string(t.year()) + '-'
        + quickPad(string(t.month())) + '-'
        + quickPad(string(t.day())) + '-'
        + quickPad(string(t.hours()))
    }

    // Check date path against timestamp, allowing for clock skew
    function checkDatePath(datePath, t) {
      return datePath == buildDatePath(t + duration.value(1, 'h'))
          || datePath == buildDatePath(t)
          || datePath == buildDatePath(t - duration.value(1, 'h'));
    }

    // Check schema of uploaded document
    function checkFields(d) {
      return
          // Check top level required fields
          d.payload != null
          // nothing extraneous at top level
          && d.keys().toSet().hasOnly(['certificateChain', 'signature', 'payload'])
          // Check payload required fields
          // uuid, created already enforced elsewhere
          && d.payload.schemaVersion != null
          && d.payload.encryptedDataShares != null
          // nothing extraneous at payload level
          && d.payload.keys().toSet().hasOnly([
            'uuid', 'created', 'schemaVersion', 'encryptedDataShares', 'prioParams'
          ])
          // share per server
          && d.payload.encryptedDataShares.size() == d.payload.prioParams.numberServers
          // Check prioParams required fields
          && d.payload.prioParams != null
          && d.payload.prioParams.bins != null
          && d.payload.prioParams.epsilon != null
          && d.payload.prioParams.numberServers != null
          && d.payload.prioParams.prime != null
          // nothing extraneous at prioParams level
          && d.payload.prioParams.keys().toSet().hasOnly([
            'bins', 'epsilon', 'hammingWeight', 'numberServers', 'prime'
          ]);
    }

    // Check metric name
    function checkMetricName(n) {
      return n in [
          // Currently supported metrics:
          // https://github.com/google/exposure-notifications-android/tree/master/app/src/main/java/com/google/android/apps/exposurenotification/privateanalytics/metrics
          'fakeMetric-v1',
          'histogramMetric-v1',
          'PeriodicExposureNotificationInteraction-v1',
          'PeriodicExposureNotification-v1'
      ];
    }

    match /{top}/{uuid}/{date}/{metricName} {
      allow create: if request.resource.data.payload.uuid == uuid
                    && top.matches('uuid[0-9]*')
                    && request.resource.data.payload.created == request.time
                    // Don't ingest anything with auth tokens attached
                    && request.auth == null
                    && checkDatePath(date, request.resource.data.payload.created)
                    && checkFields(request.resource.data)
                    && checkMetricName(metricName);
    }
  }
}
